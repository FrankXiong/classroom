void function(e){var t="2.0.4",n=e.AV||{};e.AV=n,"function"==typeof define&&define.amd&&define("AV",[],function(){return n});var o={heartbeatsTime:3e4},i={},r={},s={open:"open",close:"close",message:"message",reuse:"reuse",error:"error"},a=function(){var t={options:void 0,ws:void 0,heartbeatsTimer:void 0,ec:void 0,closeFlag:!1,reuseTimer:void 0},n=function(){i.log("WebSocket opened."),r.loginPush(t.options),r.heartbeats(),r.guard(),t.ec.emit(s.open)},a=function(){i.log("WebSocket closed."),t.ec.emit(s.close)},c=function(e){var n=JSON.parse(e.data);if("data"===n.cmd){r.ackPush(n.ids);var o,i=n.msg.length;for(o=0;i>o;o++)t.ec.emit(s.message,n.msg[o])}},u=function(e){throw e},p=function(e){t.ws.send(JSON.stringify(e))},d=function(e,t,n){var o=[];"string"==typeof e?o.push(e):o=e,r.channels(o,t,n)};return r.getId=function(e){var t="AV/"+e.appId+"/installationId",n=i.storage(t);return n?n:(id=i.getId(),e.id=id,r.sendId(e,function(e){i.storage(t,id)}),id)},r.sendId=function(e,n){i.ajax({url:"https://"+t.options.host+"/1.1/installations",method:"post",appId:e.appId,appKey:e.appKey,data:{deviceType:e.deviceType,installationId:e.id,channels:e.channels}},function(o){o?n&&(n(o),t.ec.emit("leancloud-send-id-ok")):setTimeout(function(){r.sendId(e)},5e3)})},r.sendPush=function(e,n){i.ajax({url:"https://"+t.options.host+"/1.1/push",method:"post",appId:e.appId,appKey:e.appKey,data:{data:e.data,channels:e.channels}},function(t,o){if(t)n&&n(t);else{if(403===o.code||404===o.code)throw o.error;setTimeout(function(){r.sendPush(e,n)},5e3)}})},r.channels=function(e,n,o){var r={installationId:t.options.id,deviceType:t.options.deviceType};o?r.channels={__op:"Remove",objects:e}:r.channels=e,i.ajax({url:"https://"+t.options.host+"/1.1/installations",method:"post",appId:t.options.appId,appKey:t.options.appKey,data:r},function(e){n&&n(e)})},r.createSocket=function(e){var o=new WebSocket(e);t.ws=o,o.addEventListener("open",n),o.addEventListener("close",a),o.addEventListener("message",c),o.addEventListener("error",u)},r.heartbeats=function(){p({}),t.ws.addEventListener("message",function(){t.heartbeatsTimer&&clearTimeout(t.heartbeatsTimer),t.heartbeatsTimer=setTimeout(function(){p({})},o.heartbeatsTime)})},r.guard=function(){t.ec.on(s.close,function(){t.closeFlag||t.ec.emit(s.reuse)})},r.connect=function(e){var n=e.server;if(!(n&&i.now()<n.expires))throw t.ec.emit(s.error),"WebSocket connet failed.";r.createSocket(n.server)},r.ackPush=function(e){p({cmd:"ack",appId:t.options.appId,installationId:t.options.id,ids:e})},r.loginPush=function(e){p({cmd:"login",appId:e.appId,installationId:e.id})},r.getServer=function(n,o){var r=n.appId,a=n.secure,c="",u="http://";e&&"https:"===e.location.protocol&&(u="https://");var p="";switch(n.region){case"cn":p="g0";break;case"us":p="a0";break;default:throw"There is no this region."}c=u+"router-"+p+"-push.leancloud.cn/v1/route?appId="+r,a&&(c+="&secure=1"),i.ajax({url:c},function(e,n){if(e)e.expires=i.now()+1e3*e.ttl,t.server=e,o(e);else{if(403===n.code||404===n.code)throw n.error;t.ec.emit(s.error)}})},{installationId:"",cache:t,open:function(e){var n=this;return r.getServer(t.options,function(e){e&&r.connect({server:t.server})}),e&&t.ec.on(s.open,e),t.ec.once(s.reuse+" "+s.error,function(){t.reuseTimer&&clearTimeout(t.reuseTimer),t.reuseTimer=setTimeout(function(){n.open()},5e3)}),this},close:function(){return t.closeFlag=!0,t.ws.close(),this},on:function(e,n){return t.ec.on(e,n),this},once:function(e,n){return t.ec.once(e,n),this},off:function(e,n){return t.ec.off(e,n),this},emit:function(e,n){return t.ec.emit(e,n),this},send:function(e,n){var o={appId:t.options.appId,appKey:t.options.appKey};if(e.channels||e.where||e.expiration_time||e.expiration_interval||e.push_time){for(var i in e)o[i]=e[i];r.sendPush(o,n)}else o.data=e,r.sendPush(o,n);return this},subscribe:function(e,t){return d(e,t),this},unsubscribe:function(e,t){return d(e,t,!0),this},receive:function(e){if(!e)throw"Receive must hava callback.";return t.ec.on(s.message,function(t){e(t)}),this}}};n.push=function(t){if("object"!=typeof t)throw"AV.push need a argument at least.";if(t.appId){if(t.appKey){var n=e.WebSocket.loadFlashPolicyFile?!1:!0;switch(t={appId:t.appId,appKey:t.appKey,peerId:t.clientId,secure:"undefined"==typeof t.secure?n:t.secure,region:t.region||"cn",channels:t.channels||[],deviceType:"web"},t.region){case"cn":t.host="leancloud.cn";break;case"us":t.host="avoscloud.us"}var o=a();return o.cache.options=t,t.id=r.getId(t),o.installationId=t.id,o.cache.ec=i.eventCenter(),o}throw"Options must have appKey."}throw"Options must have appId."},n.push.version=t,n.push._tool=i,n.push._engine=r,i.noop=function(){},i.getId=function(){var e=function(){return Date.now().toString(36)+Math.random().toString(36).substring(2,3)};return"AV-"+e()+"-"+e()+"-"+e()},i.log=function(e){console.log(e)},i.ajax=function(e,t){var n=e.url,o=e.method||"get",i=new XMLHttpRequest;i.open(o,n),("post"===o||"put"===o)&&i.setRequestHeader("Content-Type","application/json"),e.appId&&i.setRequestHeader("X-AVOSCloud-Application-Id",e.appId),e.appKey&&i.setRequestHeader("X-AVOSCloud-Application-Key",e.appKey),i.onprogress=function(){},i.ontimeout=function(){},i.timeout=0,i.onload=function(e){i.status>=200&&i.status<300?t(JSON.parse(i.responseText)):t(null,JSON.parse(i.responseText))},i.onerror=function(e){throw t(null,e),"Network error."},i.send(JSON.stringify(e.data))},i.now=function(){return Date.now()},i.storage=function(t,n){if(!n){var o=e.localStorage.getItem(t);return/^[\{|\[]/.test(o)&&/[\}|\]]$/.test(o)&&(o=JSON.parse(o)),o}"object"==typeof n&&(n=JSON.stringify(n)),e.localStorage.setItem(t,n)},i.eventCenter=function(){function e(e){var t=[],n=0,o=e.length;if(o){for(;o>n;n++)e[n]&&t.push(e[n]);return t}return null}var t={},n={},o=function(e,o,i){if(!e)throw"No event name.";if(!o)throw"No callback function.";var r,s=e.split(/\s+/);r=i?n:t;for(var a=0,c=s.length;c>a;a++)s[a]&&(r[s[a]]||(r[s[a]]=[]),r[s[a]].push(o))},i=function(e,o,i){var r;if(r=i?n:t,r[e])for(var s=0,a=r[e].length;a>s;s++)if(r[e][s]===o)return void(r[e][s]=null)};return{on:function(e,t){return o(e,t),this},once:function(e,t){return o(e,t,!0),this},emit:function(o,r){if(!o)throw"No emit event name.";var s=0,a=0;if(t[o]){for(s=0,a=t[o].length;a>s;s++)t[o][s]&&t[o][s].call(this,r);t[o]=e(t[o])}if(n[o]){for(s=0,a=n[o].length;a>s;s++)n[o][s]&&(n[o][s].call(this,r),i(o,n[o][s],!0));n[o]=e(n[o])}return this},off:function(e,t){return i(e,t),this}}}}(window);